const tools = require('./tools.js')
const config = require('../sverd.json')

module.exports = async function() {
  const domains = config.env.domains.map(d => `-d ${d}`).join(' ')
  tools.run('update.sh')
  tools.run('system.sh')
  tools.run('shell.sh')
  tools.run('certbot.sh', config.email, domains)
  tools.fetch(config.env.key, './files/letsencrypt')
  tools.fetch(config.env.cert, './files/letsencrypt')
  console.log(`\nCopied SSL certificate files to './files/letsencrypt'`)
  tools.run('nginx.sh')
  tools.run('mongodb.sh')
  tools.run('waveorb.sh')
  tools.run('firewall.sh')
  tools.put('./config/etc')
  tools.put('./config/usr')
  tools.env('/etc/nginx/conf.d/proxy.conf', 'names', 'cert', 'key')
  tools.env('/etc/systemd/system/appserver@.service', 'exec')
  tools.run('start.sh')
  tools.run('reboot.sh')
  console.log('\nPlease wait, rebooting...')
  tools.ping()
  console.log('Done!')
}
